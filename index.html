<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Oxgoose Radio</title>
<style>
  :root{
    --bg:#05040a;
    --stroke: rgba(255,255,255,.10);
    --shadow: 0 24px 90px rgba(0,0,0,.65);
    --radius: 18px;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    background:
      radial-gradient(1200px 700px at 50% 35%, rgba(255,75,214,.12), transparent 60%),
      radial-gradient(1000px 700px at 55% 45%, rgba(108,123,255,.14), transparent 62%),
      radial-gradient(1200px 900px at 50% 50%, rgba(70,255,149,.08), transparent 60%),
      var(--bg);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:22px;
    color:#e9e9f2;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  /* Stage (Scarlett image + overlays live here) */
  #stage{
    position:relative;
    width:min(92vw, 920px);
    aspect-ratio: 3 / 4;
    border-radius: var(--radius);
    overflow:hidden;
    box-shadow: var(--shadow);
    border:1px solid var(--stroke);
    background:#0b0712;
    user-select:none;
    -webkit-user-select:none;
    touch-action:manipulation;
  }

  /* Background image */
  #bg{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    filter:saturate(1.05) contrast(1.03);
    transform: translateZ(0);
  }

  /* Soft vignette */
  #vignette{
    position:absolute; inset:0;
    background:
      radial-gradient(120% 90% at 50% 30%, rgba(0,0,0,0), rgba(0,0,0,.35) 62%, rgba(0,0,0,.72) 100%),
      linear-gradient(to bottom, rgba(0,0,0,.06), rgba(0,0,0,.55));
    pointer-events:none;
  }

  /* Clickable hotspots layer */
  #overlay{
    position:absolute; inset:0;
    pointer-events:auto;
  }
  .hotspot{
    position:absolute;
    border-radius: 12px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.10);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    letter-spacing: .08em;
    font-size: 12px;
    text-transform: uppercase;
    color: rgba(255,255,255,.65);
    cursor:pointer;
    transition: transform .08s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
  }
  .hotspot:active{ transform: scale(.98); }
  .hotspot:hover{
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.18);
    color: rgba(255,255,255,.82);
  }
  /* If you want the hotspots invisible to viewers, uncomment:
  .hotspot{ opacity:0; }
  .hotspot:hover{ opacity:.08; }
  */

  /* The sign text that replaces the baked-in "OXGOOSE RADIO" */
  #signText{
    position:absolute;
    left:50%;
    bottom: 18.8%;
    transform: translateX(-50%);
    width: 70%;
    height: 6.9%;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    user-select:none;
    -webkit-user-select:none;
  }
  /* dark glass behind the letters for legibility */
  #signText::before{
    content:"";
    position:absolute;
    inset: 8% 2%;
    border-radius: 14px;
    background: linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.35));
    box-shadow: inset 0 0 0 1px rgba(120,255,120,.08);
    filter: blur(.0px);
  }

  /* viewport that clips long titles */
  .signClip{
    position:relative;
    width: 94%;
    overflow:hidden;
    white-space:nowrap;
    text-align:center;
  }

  /* neon-ish text */
  .signInner{
    display:inline-block;
    font-family: Impact, "Arial Black", system-ui, sans-serif;
    font-size: clamp(18px, 2.5vw, 40px);
    letter-spacing: 2px;
    color: #39ff14;
    text-shadow:
      0 0 6px rgba(57,255,20,.75),
      0 0 14px rgba(57,255,20,.55),
      0 0 26px rgba(26,255,0,.35);
    padding: 0 10px;
    will-change: transform;
  }

  /* marquee mode */
  .marquee .signInner{
    padding-left: 100%;
    animation: marquee linear infinite;
    animation-duration: var(--marquee-duration, 12s);
  }
  @keyframes marquee{
    0%   { transform: translateX(0); }
    100% { transform: translateX(var(--marquee-distance, -120%)); }
  }

  /* Hide the audio element */
  audio{ display:none; }
</style>
</head>
<body>

<div id="stage" aria-label="Oxgoose Radio Player">
  <img id="bg" alt="Scarlett UI" src="scarlett-ui.jpg" />
  <div id="overlay"></div>

  <div id="signText" aria-hidden="true">
    <div class="signClip" id="signClip">
      <span class="signInner" id="signInner">Loadingâ€¦</span>
    </div>
  </div>

  <div id="vignette"></div>
</div>

<audio id="audio" preload="none"></audio>

<script>
(() => {
  // =========================
  // CONFIG
  // =========================
  const OWNER  = "OxgooseRadio";
  const REPO   = "Oxgoose-Radio";
  const BRANCH = "main";
  const MP3_PATH = ""; // e.g. "mp3" if your files are inside /mp3

  // =========================
  // DOM
  // =========================
  const stage   = document.getElementById("stage");
  const overlay = document.getElementById("overlay");
  const audio   = document.getElementById("audio");
  const signClip  = document.getElementById("signClip");
  const signInner = document.getElementById("signInner");

  // =========================
  // Hotspots (percent of stage)
  // =========================
  const LS_KEY = "oxgoose_hotspots_v3";
  const DEFAULT_HOTSPOTS = [
    { id:"play",    label:"PLAY",    x:24.5, y:44.8, w:11.5, h:4.9 },
    { id:"pause",   label:"PAUSE",   x:37.7, y:44.8, w:11.8, h:4.9 },
    { id:"next",    label:"NEXT",    x:50.9, y:44.8, w:11.5, h:4.9 },
    { id:"shuffle", label:"SHUFFLE", x:64.1, y:44.8, w:12.2, h:4.9 },
  ];

  function loadHotspots(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return DEFAULT_HOTSPOTS.map(h => ({...h}));
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed) || !parsed.length) return DEFAULT_HOTSPOTS.map(h => ({...h}));
      return parsed.map(h => ({
        id: h.id,
        label: h.label ?? (h.id || "").toUpperCase(),
        x: +h.x, y:+h.y, w:+h.w, h:+h.h
      })).filter(h => h.id && isFinite(h.x) && isFinite(h.y) && isFinite(h.w) && isFinite(h.h));
    }catch{
      return DEFAULT_HOTSPOTS.map(h => ({...h}));
    }
  }

  function pctToPxRect(h){
    const r = stage.getBoundingClientRect();
    return {
      left: (h.x/100)*r.width,
      top:  (h.y/100)*r.height,
      width:(h.w/100)*r.width,
      height:(h.h/100)*r.height
    };
  }

  let hotspotNodes = new Map();
  function buildHotspots(){
    overlay.innerHTML = "";
    hotspotNodes.clear();
    const hs = loadHotspots();
    for (const h of hs){
      const el = document.createElement("div");
      el.className = "hotspot";
      el.dataset.id = h.id;
      el.textContent = h.label || h.id.toUpperCase();
      overlay.appendChild(el);
      hotspotNodes.set(h.id, {data:h, el});
    }
    positionHotspots();
  }

  function positionHotspots(){
    for (const {data, el} of hotspotNodes.values()){
      const r = pctToPxRect(data);
      el.style.left = r.left + "px";
      el.style.top = r.top + "px";
      el.style.width = r.width + "px";
      el.style.height = r.height + "px";
    }
  }

  window.addEventListener("resize", () => positionHotspots());

  // =========================
  // Playlist + player
  // =========================
  let tracks = [];      // {name, url}
  let currentIndex = 0;
  let shuffleOn = true;
  let shuffled = [];
  let shufflePos = 0;

  function cleanName(name){
    return String(name || "").replace(/\.mp3$/i,"");
  }

  function setSignTitle(text){
    // Update text
    signInner.textContent = text || "";
    // Decide marquee
    signClip.classList.remove("marquee");
    // Wait a frame so measurements are accurate
    requestAnimationFrame(() => {
      const clipW = signClip.clientWidth;
      const textW = signInner.scrollWidth;
      if (textW > clipW + 8){
        // distance: move left by (textW + clipW)
        const distancePx = textW + clipW;
        // duration proportional to distance (px / speed)
        const speed = 90; // px/sec
        const duration = Math.max(10, Math.min(40, distancePx / speed));
        signClip.style.setProperty("--marquee-distance", (-distancePx) + "px");
        signClip.style.setProperty("--marquee-duration", duration + "s");
        signClip.classList.add("marquee");
      }
    });
  }

  function setTrackIndex(i){
    if (!tracks.length) return;
    currentIndex = (i + tracks.length) % tracks.length;
    const t = tracks[currentIndex];
    audio.src = t.url;
    setSignTitle(cleanName(t.name));
  }

  function buildShuffle(){
    shuffled = tracks.map((_,i)=>i);
    for (let i=shuffled.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [shuffled[i],shuffled[j]] = [shuffled[j],shuffled[i]];
    }
    shufflePos = 0;
  }

  function nextTrack(){
    if (!tracks.length) return;
    if (shuffleOn){
      if (!shuffled.length) buildShuffle();
      shufflePos++;
      if (shufflePos >= shuffled.length){
        buildShuffle();
      }
      setTrackIndex(shuffled[shufflePos]);
    }else{
      setTrackIndex(currentIndex + 1);
    }
    // keep playing if already playing
    if (!audio.paused) audio.play().catch(()=>{});
  }

  function toggleShuffle(){
    shuffleOn = !shuffleOn;
    if (shuffleOn){
      buildShuffle();
      // keep current track as first in shuffled order
      const pos = shuffled.indexOf(currentIndex);
      if (pos > 0) [shuffled[0], shuffled[pos]] = [shuffled[pos], shuffled[0]];
      shufflePos = 0;
    }
  }

  async function fetchTracks(){
    const pathPart = MP3_PATH ? `/${encodeURIComponent(MP3_PATH)}` : "";
    const api = `https://api.github.com/repos/${OWNER}/${REPO}/contents${pathPart}?ref=${encodeURIComponent(BRANCH)}`;
    const r = await fetch(api, { headers: { "Accept": "application/vnd.github+json" } });
    if (!r.ok) throw new Error(`GitHub API ${r.status}`);
    const data = await r.json();
    const mp3s = (Array.isArray(data) ? data : [])
      .filter(x => x && x.type === "file" && /\.mp3$/i.test(x.name))
      .map(x => ({ name: x.name, url: x.download_url }))
      .sort((a,b) => a.name.localeCompare(b.name, undefined, { numeric:true, sensitivity:"base" }));
    return mp3s;
  }

  async function init(){
    buildHotspots();

    // Hotspot actions
    overlay.addEventListener("click", async (e) => {
      const el = e.target.closest(".hotspot");
      if (!el) return;
      const id = el.dataset.id;
      if (id === "play"){
        if (!tracks.length) return;
        try{ await audio.play(); }catch{}
      }else if (id === "pause"){
        audio.pause();
      }else if (id === "next"){
        nextTrack();
      }else if (id === "shuffle"){
        toggleShuffle();
      }
    });

    // Auto-advance
    audio.addEventListener("ended", () => nextTrack());

    // Load playlist
    try{
      tracks = await fetchTracks();
      if (!tracks.length){
        setSignTitle("No MP3s found");
        return;
      }
      // Pick first track and prep shuffle order
      setTrackIndex(0);
      buildShuffle();
      // Keep current as first
      const pos = shuffled.indexOf(0);
      if (pos > 0) [shuffled[0], shuffled[pos]] = [shuffled[pos], shuffled[0]];
      shufflePos = 0;

      // Optional: auto-start is usually blocked; user taps PLAY hotspot.
      setSignTitle(cleanName(tracks[0].name));
    }catch(err){
      console.error(err);
      setSignTitle("Error loading MP3s");
    }
  }

  init();
})();
</script>
</body>
</html>
